<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <link rel="icon" type="image/svg+xml" href="/vite.svg" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>OpenClaw Secure Installer</title>
  <link rel="stylesheet" href="./style.css" />
  <script type="module" src="/src/main.ts" defer></script>
</head>

<body>
  <div class="container">
    <h1>OpenClaw Secure Installer</h1>

    <!-- Stepper / Progress -->
    <div class="stepper">
      <div class="step active" id="step-1-indicator">1. Check</div>
      <div class="step" id="step-2-indicator">2. Configure</div>
      <div class="step" id="step-3-indicator">3. Install</div>
      <div class="step" id="step-4-indicator">4. Run</div>
    </div>

    <hr class="separator" />

    <!-- Step 1: Docker Check -->
    <div id="step-1" class="step-content active">
      <h2>System Check</h2>
      <div class="card">
        <div class="status-row">
          <span>Docker CLI:</span>
          <span id="status-cli" class="pill neutral">Pending</span>
          <span id="version-cli" class="version-info"></span>
        </div>
        <div class="status-row">
          <span>Docker Daemon:</span>
          <span id="status-daemon" class="pill neutral">Pending</span>
          <span id="version-server" class="version-info"></span>
        </div>
        <div class="status-row">
          <span>Docker Compose:</span>
          <span id="status-compose" class="pill neutral">Pending</span>
          <span id="version-compose" class="version-info"></span>
        </div>
      </div>

      <div id="remediation" class="alert hidden"></div>

      <div class="actions">
        <button id="check-docker" class="primary">Check System</button>
        <button id="step-1-next" class="secondary hidden">Next</button>
      </div>

      <details id="diagnostics-panel" class="hidden">
        <summary>Diagnostics</summary>
        <ul id="diagnostics"></ul>
      </details>
    </div>

    <!-- Step 2: Configure -->
    <div id="step-2" class="step-content hidden">
      <h2>Configuration</h2>
      <form id="config-form">
        <div class="form-group">
          <label for="http-port">HTTP Port</label>
          <input type="number" id="http-port" value="80" />
        </div>
        <div class="form-group">
          <label for="https-port">HTTPS Port</label>
          <input type="number" id="https-port" value="443" />
        </div>
        <div class="form-group">
          <label>Safe Mode</label>
          <div style="display:flex; align-items:center;">
            <input type="checkbox" checked disabled id="safe-mode" />
            <span style="margin-left: 0.5rem;">Enabled (Enforced)</span>
          </div>
        </div>
        <div class="form-group">
          <label>Storage Path</label>
          <div id="app-data-path" class="path-display text-muted text-small">Loading...</div>
        </div>
      </form>
      <div class="actions">
        <button id="step-2-next" class="primary">Save &amp; Configure</button>
      </div>
    </div>

    <!-- Step 3: Install/Start -->
    <div id="step-3" class="step-content hidden">
      <h2>Installation</h2>

      <!-- Gateway Runtime Image Selection -->
      <div class="card">
        <h3 class="section-title">Gateway Runtime (must be OpenClaw-compatible)</h3>
        <p class="text-small text-muted" style="margin-top:-0.5rem; margin-bottom:1rem;">
          The image must contain <strong>Node.js</strong> and the <strong>OpenClaw gateway app</strong>.
          Use the official distribution or build locally from the included <code>gateway/</code> directory.
        </p>

        <div class="mode-tabs">
          <button class="mode-tab active" data-mode="public">Public Image</button>
          <button class="mode-tab" data-mode="private">Private Registry</button>
          <button class="mode-tab" data-mode="local">Local Build</button>
        </div>

        <!-- Mode: Public Image -->
        <div id="mode-public" class="mode-panel">
          <div class="form-group">
            <label for="image-name">Image</label>
            <input type="text" id="image-name" value="ghcr.io/leojeulinmerville/openclaw-gateway:stable" />
          </div>
          <div class="actions-inline">
            <button id="btn-test-pull" class="secondary">Test Pull Access</button>
            <span id="pull-status" class="pill neutral">Not tested</span>
          </div>
          <p class="text-small text-muted" style="margin-top:0.5rem;">
            If the image is on GHCR, you may need: <code>docker login ghcr.io</code>
            (username = GitHub user, password = PAT with <code>read:packages</code>).
          </p>
          <div id="pull-diagnostics-box" class="terminal-inline hidden"></div>
        </div>

        <!-- Mode: Private Registry -->
        <div id="mode-private" class="mode-panel hidden">
          <div class="form-group">
            <label for="registry-url">Registry</label>
            <input type="text" id="registry-url" placeholder="e.g. ghcr.io or registry.example.com" />
          </div>
          <div class="form-group">
            <label for="private-image-name">Image</label>
            <input type="text" id="private-image-name" placeholder="e.g. myorg/openclaw-gateway:stable" />
          </div>
          <div class="actions-inline">
            <button id="btn-copy-login" class="secondary">Copy Login Command</button>
            <span id="copy-login-status" class="text-small text-muted"></span>
          </div>
          <p class="text-small text-muted">After running the login command in a terminal, click "Start Gateway" below.
          </p>
        </div>

        <!-- Mode: Local Build -->
        <div id="mode-local" class="mode-panel hidden">
          <div class="form-group">
            <label for="build-context">Path to <code>gateway/</code> directory</label>
            <input type="text" id="build-context" placeholder="e.g. D:\projects\openclaw-secure-installer\gateway" />
          </div>
          <div class="actions-inline">
            <button id="btn-build-local" class="secondary">Build Locally</button>
            <span id="build-status" class="pill neutral">Not built</span>
          </div>
          <p class="text-small text-muted">
            Builds the image as <code>openclaw-gateway:dev</code> from the Dockerfile in the gateway/ directory.
            The included gateway app provides a <code>/health</code> endpoint for verification.
          </p>
          <div id="build-logs-box" class="terminal-inline hidden"></div>
        </div>
      </div>

      <!-- Docker Smoke Test (independent of gateway image) -->
      <div class="card" style="border: 1px dashed #334155;">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <div>
            <h3 class="section-title" style="margin:0;">Docker Smoke Test</h3>
            <p class="text-small text-muted" style="margin:0.25rem 0 0;">
              Runs <code>docker run hello-world</code> to verify Docker can pull &amp; run containers.
              <strong>Does not affect gateway settings.</strong>
            </p>
          </div>
          <div class="actions-inline" style="margin:0;">
            <button id="btn-smoke-test" class="secondary">Run Test</button>
            <span id="smoke-status" class="pill neutral">Not tested</span>
          </div>
        </div>
        <div id="smoke-diagnostics-box" class="terminal-inline hidden"></div>
      </div>

      <!-- Install logs -->
      <div class="terminal" id="install-logs">Waiting to start...</div>

      <!-- Error card (only shown on failure when gateway NOT running) -->
      <div id="gateway-error" class="error-card hidden">
        <h3 id="gateway-error-title"></h3>
        <p id="gateway-error-message"></p>
        <div id="gateway-remediation" class="remediation-block hidden">
          <h4>How to fix</h4>
          <ol id="gateway-remediation-steps"></ol>
        </div>
        <details>
          <summary>Raw diagnostics</summary>
          <pre id="gateway-error-diagnostics" class="terminal" style="height:120px;"></pre>
        </details>
      </div>

      <div class="actions">
        <button id="start-gateway" class="primary">Start Gateway</button>
        <button id="btn-open-appdata" class="secondary">Open AppData Folder</button>
      </div>
    </div>

    <!-- Step 4: Running -->
    <div id="step-4" class="step-content hidden">
      <h2>Gateway Running</h2>

      <!-- Warning banner for "already running but issues" -->
      <div id="gateway-warning" class="warning-banner hidden">
        <span class="warning-icon">⚠️</span>
        <span id="gateway-warning-text"></span>
      </div>

      <div class="success-card">
        <p id="gateway-active-status">✅ OpenClaw Gateway is active.</p>
        <p>Local URL: <a href="http://localhost" target="_blank">http://localhost</a></p>
        <div class="status-row" style="margin-top:0.75rem;">
          <span>Health:</span>
          <span id="health-status" class="pill neutral">Not checked</span>
          <button id="btn-check-health" class="secondary"
            style="margin-left:0.5rem; padding:0.25rem 0.75rem; font-size:0.85rem;">Check /health</button>
        </div>
      </div>
      <div class="actions">
        <button id="stop-gateway" class="danger">Stop Gateway</button>
        <button id="view-logs" class="secondary">View Logs</button>
        <button id="btn-open-appdata-run" class="secondary">Open AppData</button>
      </div>
      <div class="terminal hidden" id="runtime-logs"></div>
    </div>

    <div class="footer">
      <p id="install-id" class="text-small text-muted"></p>
      <p id="compose-path-display" class="text-small text-muted"></p>
    </div>
  </div>
</body>

</html>
